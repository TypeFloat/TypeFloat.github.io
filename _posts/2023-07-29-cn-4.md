---
title: 计算机网络 —— VOL.4 网络层
tags: "计算机网络"
key: cn-4
sidebar:
  nav: cn
---

本系列是计算机网络学习的记录笔记，参考了中科大郑老师在B站上发布的[教学视频](https://www.bilibili.com/video/BV1JV411t7ow/)。文章主要介绍计算机网络中网络层的相关内容。<!--more-->

# 导论

网络层提供的服务有：

- 在发送主机和接收主机对之间传送段(segment)；
- 在发送端将段封装到数据报中；
- 在接收端，将段上交给传输层实体；
- 网络层协议存在于主机和路由器；
- 路由器检查每一个经过它的IP数据报的头部。

网络层的关键功能是转发和路由：

- 转发：将分组从路由器的输入接口转发到合适的输出接口；
  - 传统方式：基于目标地址+路由表；
  - SDN（Software-Defined Networking）方式：基于多个字段+路由表；

- 路由：使用路由算法来决定分组从发送主机到目标接受主机的路径；
  - 传统方式：在路由器中实现；
  - SDN方式：在远程服务器中实现，路由器作为本地的控制代理。


传输层和网络层提供的服务都是主机与主机之间的通信，但网络层包括了通信路径上的路由器。

# 路由器组成

通用路由器体系架构的路由器的主要组成有输入输出端口和交换机构。

## 输入输出端口

路由器的输入输出端口承担了物理层和数据链路层的相关功能。在输入端口和输出端口处设有缓存，原因是当交换机构的交换速率与输入端口的汇聚速率/输出端口的传输速率不匹配时，可能会造成分组丢失。

分组到达输入端口或输出端口后进入缓存队列排队，下一个将被链路传输的分组由调度策略决定，常见的调度策略有FIFO、优先级调度、循环扫描。

如果分组到达时，缓存队列已满，则需要抛弃一定的分组，同样由调度策略决定，常见的有随机丢弃、根据优先级丢弃、丢弃刚到达的分组。

## 交换机构

交换机构将分组从输入缓冲区传输到合适的输出端口，交换速率指的是分组从输入端口传输到输出端口的速率。有三种典型的交换机构：Memory、Bus和Crossbar。

![](/assets/cn-4-1.jpg)

- Memory是第一代路由器采取的交换机构，路由器本身是一个通用计算机，使用软件的方式实现路由器功能，在CPU的直接控制下交换分组（分组被拷贝到系统内存，CPU从分组的头部提取出目 地址，查找转发表，找到对应的输出端口，拷贝到输出端口），这样的方式一次只能转发一个分组，且转发速率被内存带宽所限制。
- Bus的工作原理是数据报通过共享总线，从输入端口转发到输出端口，仍然一次只能转发一个分组，转发速率被总线带宽限制，但对于接入或企业级路由器，其带宽完全足够。
- Crossbar通过控制器端接相应的总线，实现同时并发转发多个分组，克服了总线带宽的限制。

# Internet Protocol

## IPv4 数据报格式

![](/assets/cn-4-2.jpg)

## IP分片和重组

不同的数据链路层具有不同的最大传输单元（MTU，通常小于IP数据报），为了统一IP数据报在不同数据链路层的传输，需要对较大的IP数据报进行分片，交给下层数据链路层传输，在目标主机处进行重组，合成为IP数据报。在分片时，IP数据报的头部要复制到每一个片中，用于对分片进行标识和排序。

## IPv4

### IPv4地址

IPv4的地址由32位表示，对主机或者路由器的接口（设备与物理链路的连接处）进行编址，一个IP地址和一个接口相关联。IPV4地址的常用表示形式是点分式，即每8位用10进制表示，并用小数点连接。

在网络内部，某些主机或路由器的IP地址高位部分相同，这些节点构成的网络称为子网，子网内的主机要求可以在物理上相互直接到达，无需路由器介入（可以借助交换机）。IPV4网络地址可以分为5类：

- A类：高8位为子网地址，剩余24位为主机地址，起始为0；
- B类：高16位为子网地址，剩余16位为主机地址，起始为10；
- C类：高24位为子网地址，剩余8位为主机地址，起始为110；
- D类：组播地址，起始为1110；
- E类：起始为11110，预留使用。

此外，还约定了一些特殊的IP地址：

- 子网部分全为0：本网络；
- 主机部分全为0：本主机；
- 主机部分全为1：广播地址，指向网络内的所有主机；
- 高7位为1：127.x.x.x，回路地址；
- 内网专用IP地址：只在局部网络中有意义，不会被分为公网地址：
  - 10.0.0.0-10.255.255.255，子网掩码为255.0.0.0；
  - 172.16.0.0-172.31.255.255，子网掩码为255.255.0.0；
  - 192.168.0.0-192.168.255.255，子网掩码为255.255.255.0。

子网掩码同样是一个32位的数，用于在一个IP地址中标识子网地址和主机地址的位（子网掩码0位代表主机地址，1位代表子网地址），因此ABC三类网络的子网掩码是固定的。还有一种特殊的网络地址：无类域间路由，指的是IP地址不按照预定的5类地址对子网号和主机号进行划分，其子网号和主机号的长度可以是任意的，通过子网掩码确定子网号和主机号的划分位置。

### DHCP

DHCP，Dynamic Host Configuration Protocal，主要功能是让主机在加入网络的时候，动态地从DHCP服务器获得IP地址，其工作过程如下：

1. 主机广播发送“DHCP discover”报文（可选）；
2. DHCP服务器用“DHCP offer”提供报文响应（可选）；
3. 主机请求IP地址，发送“DHCP request”报文；
4. DHCP服务器通过“DHCP ack”发送IP地址、默认网关、DNS服务器域名和IP地址、子网掩码等信息。

### ICANN

ICANN，Internet Corporation for Assigned Names and Numbers，IP地址的授权机构，负责分配IP地址、管理DNS、分配域名和解决冲突。

## NAT

NAT，Network Address Translation，其动机是本地网络只有一个有效IP，本地网络内部的设备使用内网IP：

- 不需要ISP分配一块地址，用一个IP地址用于所有的局域网设备；
- 可以在局域网改变设备地址的情况下而无需通知外界；
- 可以在ISP地址发生变化的情况下无需改变内部设备地址；
- 局域网内部的设备没有明确的地址，对外是不可见的。

NAT的实现方式是：

- 对于外出数据报，替换源地址和端口号为NAT的IP地址和新的端口号，目标IP和端口不变；
- 对于进入数据报，替换目标IP地址和端口号为NAT表中记录的表项。

NAT的存在的问题是：

- 如果在一个局域网内设备特别多，每台设备上的网络应用进程又特别多，可能会导致NAT的端口号不够用；
- 具有NAT功能的路由器是网络层设备，但是NAT需要对传输层的端口信息进行篡改，违背了分层与端到端的原则；
- NAT在内网设备主动与外网设备建立连接时没有问题，是外网设备主动与内网设备建立连接是无法实现的，解决该问题可以使用以下方法：
  1. 静态配置NAT，即将NAT的端口号和内网设备的内网IP与端口号静态绑定；
  2. UPnP/IGD协议，与静态配置NAT类似，实际上是实现了NAT的自动动态配置；
  3. 中继，通过中继服务器实现两台设备的连接。

## IPv6

IPv6的出现是为了解决IPv4存在的一些问题：

- 32位地址空间已经全部被占用（主要）；
- IPv4数据报在转发时，每经过一跳，TTL都会被改变，因此每次都需要重新计算校验和，加剧了路由器的负担。

IPv6的数据报头部固定为40字节，在传输过程中，不允许分片（要求源主机发送的数据报足够小）。

![](assets/cn-4-3.jpg)

正在使用IPv4的设备数量已经非常庞大，因此IPv6的升级采用了平滑的方式。在升级过程中，同时存在IPv4路由器和IPv6路由器，在两类设备类内通信采用相应的协议；如果在类间通信，需要使用隧道技术，隧道由支持双协议的路由器实现，其本质是由IPv4数据报携带IPv6数据报进行传递。

# 通用转发和SDN

在传统方式中，由路由器承担了网络层的主要功能，但随着网络层功能的扩展，例如交换技术、防火墙、NAT、负载均衡等，出现了越来越多相应的网络设备，每台设备都分布式的继承了网络层控制平面和数据平面的功能。这样的集成方式导致网络设备升级困难、管理困难、网络设备种类繁多等问题。

为了解决上述问题，提出了SDN的方式，通过远程的控制器集中实现控制逻辑，实现了数据平面和控制平面的分离。SDN由远程控制器和网络交换机CA代理组成。SDN可以通过服务接口向网络交换机发送不同的流表，使网络交换机可以承担路由器、防火墙等不同的功能，即使得网络设备可编程。

# 路由选择算法

## 路由算法的概念

路由指按照某种指标（传输延迟、所经过的站点数量等）找到一条从源节点到目标节点的较好路径，路由路径是按照子网为单位进行计算的。路由选择算法是网络层软件的一部分，完成路由功能。路由算法的输入是网络拓扑关系、边的代价以及源节点，输出是源节点的汇集树（此节点到所有其它节点的最优路径形成的树）。

## 路由选择算法的原则

- 正确性：算法必须是正确和完整的；
- 简单性：算法实现应简单，不能为了获取路由信息而增加通信量和计算时间；
- 健壮性：算法应能适应通信量和网络拓扑的变化；
- 稳定性：算法产生的路由不能摇摆；
- 公平性：算法对每一个站点都公平；
- 最优性：算法在某一个指标上最优。

## 路由算法的分类

全局或者局部路由信息：

- 全局：所有的路由器都拥有完整的拓扑和边的代价信息，link state 算法；
- 分布式：路由器只知道与它有物理连接关系的邻居路由器的路由代价，迭代地与邻居路由器交换、计算路由信息，distance vector 算法。

静态或者动态路由：

- 静态：路由随时间变化缓慢，不能适应网络拓扑和通信量的变化，非自适应算法；
- 动态：路由变化很快、周期性更新，能适应网络拓扑和通信量的变化，自适应路由选择算法。

## Link State算法

Link State算法的基本思想是：

1. 发现相邻节点，获取对方的网络地址；
2. 测量到相邻节点的代价；
3. 组成一个LS分组，描述它到相邻节点的代价情况；
4. 将分组通过扩散的方法发到所有其他服务器；
5. 通过Dijkstra算法找出最短路径。

LS分组中包括发送者姓名、序号、年龄、相邻节点及延迟列表。序号主要为了解决无穷扩散问题，防止路由器扩散重复或者旧的分组。年龄用于保证及时更新分组信息，每过一个时间多，分组年龄衰减1，衰减为0时，需要重新生成分组。

性能评价：

- 消息复杂度：拓扑网中有n个节点、E条链路时，需要发送O(nE)个报文；
- 收敛时间：$O(n^2)$，有可能出现震荡；
- 健壮性：路由器出现故障时，由于节点只计算自己的路由表，错误信息影响较小。

OSPF，Open Shortest Path First，是LS算法的一种实现。OSPF报文通过IP数据报进行传递，且OSPF报文是经过认证的，所以安全性较高。OSPF在大型网络中支持层次化结构，限制每个报文只在区域内部进行传递，如果需要跨区域传递，则先传输到骨干路由器，由骨干路由器对报文进行传递。

## Distance Vector算法

Distance Vector的基本思想是：

1. 每个路由器各自维护一张路由表；
2. 定期向自己的邻居节点发送路由表（实际上是按照既定的节点顺序，传输一个距离向量）；
3. 根据获取的其他路由器的路由表，采用动态规划算法更新自己的路由表。

当某个路由器接入或者有更短的路径时，其路由信息以每一个交换周期前进一个路由器的速度进行；但当某个路由器断开或者路径变得更长时，可能会出现无穷计算问题（可达路径上出现环路）。

性能评价：

- 消息复杂度：只与邻居交换信息，消息复杂度较低；
- 收敛时间：收敛较慢，可能出现无穷计算问题；
- 健壮性：路由器出现故障时，错误可能会扩散到全网，健壮性较差。

RIP，Routing Information Protocal，是DV的一种实现。每隔30s和邻居交换一次DV（不包括主动请求的情况），每个通告最多包含25个目标子网。一个节点如果180s后仍没有收到邻居的通告信息，则可能是邻居或链路失效。此时该节点会主动向其他邻居发送该通告，防止对网络产生大规模影响。RIP以应用进程的方式实现，通过UDP协议发送报文，即网络层协议使用了传输层的服务，并以应用层实体的形式实现服务。

# ISP之间的路由选择

## 层次路由

层次路由是相对于平面路由来说的。平面路由指的是一个网络中的所有路由器地位是一样的，同LS、DV或其他路由算法，所有路由器都知道到其他路由器的路径。平面路由存在的问题是：当网络规模变大时，路由算法的开销会变得巨大；另一方面，网络管理者无法对网络有很好的控制，无法隐藏网络内部的细节。因此出现了层次路由的方式。

层次路由将互联网分成一个个的路由器区域，称为自治系统。一个ISP可能包含1个或多个AS，在同一个AS内部的路由器运行相同的路由协议，AS之间运行AS间路由协议。通过分层的方式，层次路由解决了路由器规模的问题，如果1个AS内的路由器数量达到一定规模，可以划分为两个AS，而对于AS之间的路由来说，只增加了一个节点。不同AS内部可以采用不同的路由协议，因此隐藏了AS内部的网络细节。

## AS间路由

互联网采用的AS间路由协议是Border Gateway Protocal协议，BGP本身是一个基于DV的算法，除了距离向量外，还添加了到达各个目标网络的详细路径。BGP分为两个部分，eBGP和iBGP。eBGP的作用是AS之间传递子网可达信息，iBGP的作用是将子网可达信息传递给AS内部的路由器。AS的网关路由器同时运行eBGP和iBGP，而AS内部的其他路由器仅需运行iBGP。

BGP是一种基于策略的协议。网关路由器之间要建立半永久的TCP连接传递BGP报文，当网络路由器接受到来自其他网关路由器的报文后，要根据策略执行相应动作：

- 接收或过滤报文；
- 是否向其他邻居转发该报文；
- 是否重新规划路由路径。
