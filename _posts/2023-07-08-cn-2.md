---
title: 计算机网络 —— VOL.2 应用层
tags: "计算机网络"
key: cn-2
sidebar:
  nav: cn
---

本系列是计算机网络学习的记录笔记，参考了中科大郑老师在B站上发布的[教学视频](https://www.bilibili.com/video/BV1JV411t7ow/)。文章主要介绍计算机网络中应用层的相关内容。<!--more-->

# 应用层协议的原理

## 网络应用的体系结构

网络应用的体系结构有3类：客户-服务模式（C/S）、对等模式（P2P）、混合体模式。

C/S模式：服务器应用处于一致运行的状态，其IP地址和端口号是公开的；客户端应用主动与服务器进行通信，与互联网有间歇性的联系，客户端的IP地址可以不是固定的，且客户端不与其他客户端进行通信。C/S模式下，服务器的可扩展性、可靠性是较差的。

P2P模式：几乎没有一直运行的服务器，任何端系统之间都可以进行通信（每一个节点既是服务器也是客户端），参与的主机间歇性连接且可以改变IP地址，这种模式的问题是难以进行管理。

混合体模式：混合体模式中，根据功能的不同选择合适的服务模式，例如在即时通信应用中，用户之间的通信使用P2P模式，而用户与中心服务器之间的通信使用C/S模式。

## 进程通信

不同主机之间，通过交换报文来进行通信，其中客户端进程是发起通信的进程，服务器进程是等待连接的进程。具体的需要关注以下三个问题。

### 进程标识和寻址问题

进程之间通过三个属性来进行寻址：主机地址即IP地址，采用的传输层协议（TCP/UDP），端口号。

### 传输层是如何向应用层提供服务的

传输层要求应用层影响向其传递的信息包括：

- 要传输的报文，即应用层SDU；
- 源地址的应用进程标识，IP+传输层协议+端口号；
- 目标地址的应用进程标识。

传输层将端口号信息和报文进行封装，封装为TCP/UDP报文段，并将IP信息和报文段向下传递给IP实体，用于下层IP数据报的封装。

具体来说，数据传递的过程要使用到Socket API，Socket API将通信双方进程抽象为socket接口，操作系统将通信的过程抽象为对一个文件的读写，因此Socket接口本质就是一个文件描述符。

TCP服务需要两个进程通信之间先建立连接，TCP套接字唯一对应了一个存储在本地的四元组信息（源IP，源端口，目标IP，目标端口），即唯一的指定了一个会话。这样在通信的过程中，只需要根据套接字来对应本地的四元组信息，而无需每次都发送IP和端口等信息，最大化的减少了层间传递的信息。

UDP服务不需要通信的双方建立连接，因此UDP套接字对应的是一个二元组（源IP，源端口），而目标IP和目标端口需要由应用层与要传输的报文一起发给传输层。

### 应用层是如何使用传输层提供的服务的

应用层需要定义应用层协议，通过Socket API向下层传递报文与解析下层传递上来的报文。

应用层协议定义了运行在不同端系统上的应用进程如何相互交换报文，包括：

- 报文类型，请求或应答报文；
- 报文语法，报文中的字段及描述；
- 字段语义；
- 进程何时、如何发送报文及对报文进行相应的规则。

应用层对传输层提供的服务的衡量指标有：

- 数据丢失率
- 延迟
- 吞吐量
- 安全性（TCP和UDP都不提供安全性保证，需要额外使用SSL/TSL等安全协议进行加密）

应用层要根据应用自身对这些衡量指标的要求选择传输层协议。

# Web 和 HTTP

## Web

Web页由一些对象构成，可以是HTML文件、JPEG图像等，WEB页含有一个基本的HTML文件，该文件包含了对若干对象的引用，通过URL对每个对象进行引用，URL的格式如下：

```
proto://(user:pwd@)host(:port)/path/resouce.html
```

其中：

- 如果资源支持匿名访问，可以不提供user与pwd；
- 如果没有提供port，会根据协议自动推断，例如http默认80端口、ftp默认21端口。

## HTTP

HTTP，全称超文本传输协议，是Web的应用层协议，采用了C/S模式，使用TCP作为传输层协议。在通信时，浏览器（HTTP客户端）与Web服务器（HTTP服务器）建立TCP连接，交换HTTP报文，服务结束后断开连接，在这个过程中，服务器不维护任何关于客户端的信息。HTTP的连接分为持久HTTP和非持久HTTP。

非持久HTTP指最多只有一个对象在TCP连接上进行发送，即完成一次请求和响应后连接就关闭*，在HTTP/1.0中使用。使用非持久HTTP，每个对象要消耗两个RTT（rount-trip-time），操作系统为每个TCP连接分配资源。

HTTP/1.1中默认使用持久连接，持久连接时，多个对象可以在TCP连接上进行传输。持久连接又分为流水方式的持久HTTP（默认）和非流水方式的持久HTTP。流失方式的持久HTTP在客户端遇到一个引用对象后就立即产生一个请求；而非流水方式持久HTTP要在客户端收到上一次的请求的响应后才能发出下一次的请求。HTTP报文有请求和响应两种报文，由客户端发出的称为请求，服务端返回的称为请求。

## HTTP请求报文

请求报文包括请求行（包括方法名、请求地址和协议版本号）、请求头和请求体。

请求方法有3类，HEAD、POST和GET。GET和POST都可以向服务器提交表单输入，区别是：GET方法的输入通过请求行的请求地址上载，而POST方法将输入写入到请求体中上载。HEAD方法仅请求HTML对象的头部信息。

在HTTP/1.1中，又新增了PUT方法和DELETE方法，PUT用于上载文件，DELETE用于删除文件。

## HTTP响应报文

响应报文包括状态行（协议版本号、响应状态码、对应的状态信息）、响应头和响应体。响应状态码如下：

- 200 OK，请求成功；
- 301 Moved Permanently，请求对象被永久转移了，新的URL在响应报文的响应头中；
- 400 Bad Request，通用的差错代码，表示请求不能被服务器解读；
- 404 Not Found，请求的文档在该服务上没有找到；
- 505 HTTP Version Not Supported，HTTP协议版本不支持；
- ……

## 用户-服务器状态：cookies

HTTP协议本身是不支持服务器维护客户端状态的，但现在的大多数门户网站都需要，可以使用cookies来实现上述功能。cookies的工作原理如下：

- 在HTTP响应报文的请求头和请求报文的请求头中有一个cookies字段；
- 在用户端系统中，浏览器负责维护管理该cookies，而在服务端，后端数据库负责维护该cookies和需要保存的状态信息；
- 客户端和服务端使用cookies作为key来验证和索引相应的状态信息。

## Web缓存

Web缓存的目的是使用户不需要访问原始服务器就可以满足请求，当请求对象不在缓存中时，缓存请求原始服务器，将响应返回给客户端，如果请求对象在缓存中，则直接返回。在这个过程中，缓存既充当了服务器的角色，也充当了客户端的角色。通常，缓存由ISP进行安装。

设置缓存的目的有：

- 降低客户端的请求响应，即减轻服务器的访问压力；
- 减少机构内部网络与Internet接入链路上的流量；
- 如果互联网大量采用了缓存，可以使较弱的ICP也能够提供有效的内容。

如果请求的对象在缓存中，但服务器更新了相应的内容，这时候使用缓存就会产生错误。可以在请求头中指定“If-modified-since”字段，使用条件GET方法。如果请求的内容如果没有修改，则只返回响应头，否则返回全部的响应。

# FTP

FTP是一个向远程主机上传输文件或从远程主机接收文件的应用，以TCP为传输协议。

FTP客户端通过21号端口（默认）与FTP服务器建立连接，该连接称为控制连接。当客户端通过控制连接向服务器发送指令，当收到一个文件传输指令后，服务器会主动与客户端建立一个数据连接，当一个文件传输完成后，服务器关闭数据连接。

FTP服务器会维护用户的状态信息。

# Email

电子邮件应用由用户代理（客户端）、邮件服务器、邮件传输协议组成。邮件传输协议包括发送（SMTP）、拉取（POP3、IMAP、HTTP）协议。

当用户代理向邮件服务器发送邮件时，邮件服务器会将邮件输入到报文队列中，并向目标邮件服务器发送。邮件服务器收到邮件后，将邮件存储在对应客户端的报文队列中，当用户代理与邮件服务器建立连接后，用户代理向邮件服务器进行拉取。

SMTP要求报文（首部和主体）为7位ASCII编码。为了扩展邮件的内容，引入了多媒体扩展MIME，可以在报文的首部声明使用MIME，从而可以传输base64编码的字符。

POP3是基本的邮件访问协议，在会话中是无状态的。IMAP相比POP3更加复杂，用户能够在服务器上处理存储的报文，例如目录管理等，在会话中保留用户状态 ss。HTTP的使用非常方便，可以实现文件的上传与下载。

# DNS

在网络传输的过程中，主机是通过IP地址进行标识的，但二进制或者点分码形式的IP地址不便于记忆，因此有必要使用一种程序将易于记忆的的表示形式（例如具有特殊意义的字符串）转换成IP地址，这就是DNS的作用。

## DNS的总体思路与目标

DNS的主要思路是：

- 分层的、基于域的命名机制；
- 若干分布式的数据库完成名字到IP地址的转换；
- Internet的核心，是运行在UDP之上的应用层服务。

DNS的主要目的：

- 实现主机名-IP地址的转换（核心功能）；
- 主机别名到规范名字的规范；
- 负载均衡。

## 如何命名

### DNS与名结构

在同一层面进行命名可以会导致重名，因此DNS采用层次化的树状结构命名方法。Internet根被划分为几百个顶级域，例如`.com`、`.edu`、`.gov`。每个域又可以在划分为若干子域，树状结构的叶子结点代表主机。

一个域负责管理其下的子域，域与物理网络无关，其划分遵从组织界限。

## 如何完成从命名到IP地址的转换

将整个DNS树状结构划分为几个互不相交的区域，每个区域都是树的一部分，每一个区域有一个名字服务器，负责维护它所管辖区域域的权威信息，例如顶级域服务器TLD，负责维护Internet根的各个子域信息。为了保障可靠性，允许将名字服务器放置在区域之外。

一个根服务存在可靠性、扩展性、可维护性等问题，因此全球部署了13个根服务器，这些服务器的作用与存储的数据都是完全相同的。

名字服务器需要维护资源记录（域名-IP地址的映射关系），格式为(Name, TTL, Class, Value, Type)。

- Name和Value的含义具体有Type进行标识；

- TTL表示生存时间，如果一条记录的生存时间是无限大，那么这条记录就是权威记录，反之就是一条缓存；
- Class表示分类，对于互联网，其值为IN；
- Type表示该条记录Name和Value的含义：
  - A：Name为域名（主机）、Value为主机的IP地址；
  - CNAME：Name为别名、Value为规范名；
  - NS：Name为域名（域）、Value为该域名的权威服务器的域名；
  - MX：Name为别名、Value为对应邮件服务器的规范名。

在实际使用中，一般会设置一个本地名字服务器，本地名字服务器不严格属于层次结构，每个ISP都有一个本地DNS服务器。当一个主机发起一个DNS查询是，查询会先送到本地DNS服务器，如果不能解析再将查询转发到层次结构中。

在查询时有两种方式：

- 递归查询

![](/assets/posts/cn-2-1.jpg)

- 迭代查询

![](assets/posts/cn-2-2.jpg)

DNS查询和响应的报文格式相同，通过首部的标识位字段来区分是查询报文还是响应报文。当名字服务器查询到一个映射后，会将该映射缓存起来，以提高查询的效率。缓存可能会导致缓存结果与权威资源记录不一致的问题，因此TTL通常设置为两天。

## 如何增加、删除、修改一个域名

无论是增加、删除还是修改一个域名，要在上级域的名字服务器中增加、删除或修改子域域名-权威服务器域名记录（NS）和子域域名-IP地址（A）两条记录。

# P2P

P2P架构中没有或者仅有极少一直运行的服务器，任何端系统之间都可以直接应用，最常见的应用场景时文件共享。实现P2P文件共享，需要解决如何定位所需资源与如何处理对等端系统的离开与加入。

## 集中式目录

集中式目录的P2P架构有一个中心服务器，中心服务器会存储各个对等节点的IP与拥有的内容，当有客户端请求资源时，先与中心服务器建立连接，中心服务器会告诉客户端哪个节点拥有其请求的资源以及节点IP地址，客户端与该节点建立对等连接，传输资源。集中式目录，其文件传输是分散的，但是定位内容是集中的。其存在的问题与C/S架构类似，中心服务器都会存在单点故障与性能瓶颈的问题，而且其资源是存储在对等节点上的，可能会出现侵犯版权的问题。

## 全分布式

全分布式架构没有任何的中心服务器，其运行依赖于所有的对等节点之间构成全覆盖网络（是一种图结构，如果两个对等节点之间建立了TCP连接，那两个节点之间就有一条边）。在某一客户端请求资源时，向其邻居发出请求，其邻居再将查询进行转发，直到查询命中，以反方向返回命中报文。

## 混合体

混合体架构综合了C/S架构和P2P架构的优势。在混合体网络中，一个对等方要么是一个组长，要么隶属于一个组长。对等方与其组长之间建立TCP连接，各个组长之间建立TCP连接。组长负责跟踪其组员节点拥有的资源并与其他组长进行查询转发、数据拷贝。

# CDN

CDN是为了解决服务器通过网络向众多用户提供流化视频内容时性能瓶颈问题而出现的应用层应用。CDN的工作原理是：CDN在全网部署非常多的缓存节点，内容提供商将服务内容（例如流式视频）预先存储在缓存节点上，用户在请求资源时，通过域名的重定向，可以就近向CDN缓存节点请求资源，从而提高用户体验。

# 套接字（Socket）

应用层进程需要使用传输层提供的服务才能完成报文的交换，传输层向应用层提供服务的方式就是套接字，套接字分为TCP套接字（可靠的、基于字节流的）和UDP套接字（不可靠的、基于数据报的）。

## TCP套接字

TCP在客户端与服务端进程之间提供了可靠的、字节流管道服务。运行过程如下：

- 服务端：
  - 创建服务端socket；
  - 与本地端口绑定；
  - 在服务端socket上阻塞式地等待用户的连接；
  - 当接收到客户端的连接请求后，解除阻塞式等待，返回一个新的socket用于与客户端通信（这样的方式允许服务器同时与多个客户端进行通信，通过源IP和源端口来区分不同的客户端）。
- 客户端：
  - 创建客户端socket（客户端socket会隐式地绑定到本地端口）；
  - 指定服务器进程的IP地址与端口号，与服务器进程连接；
  - 与服务器创建好TCP连接后，与服务器进行通信。

## UDP套接字

UDP为客户端和服务器之间提供了不可靠的数据报传送服务。使用UDP套接字时，客户端和服务器之间没有连接，因此不需要握手。发送端在每一个报文中需要明确指明目标IP地址和端口号，服务器从收到的分组中提取发送端的IP地址和端口号。其运行过程如下：

- 服务端：
  - 创建服务端socket；
  - 与本地端口绑定；
  - 接收客户端的消息。
- 客户端：
  - 创建客户端socket；
  - 与服务端socket进行通信。