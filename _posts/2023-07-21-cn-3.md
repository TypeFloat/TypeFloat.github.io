---
title: 计算机网络 —— VOL.3 传输层
tags: "计算机网络"
key: cn-3
sidebar:
  nav: cn
---

本系列是计算机网络学习的记录笔记，参考了中科大郑老师在B站上发布的[教学视频](https://www.bilibili.com/video/BV1JV411t7ow/)。文章主要介绍计算机网络中传输层的相关内容。<!--more-->

# 概述和传输层服务

传输层的主要功能是为运行在不同主机上的应用程序提供逻辑通信，传输协议运行在端系统。发送方将应用层的报文分成报文段，然后传递给网络层；接收方将报文段重组成报文，传递给应用层。传输层主要有两类协议：TCP传输协议和UDP传输协议。

TCP：

- 可靠的、保序的
- 多路复用、解复用
- 拥塞控制
- 流量控制
- 建立连接

UDP：

- 多路复用、解复用

无论是TCP还是UDP，都无法提供延迟保证以及带宽保证。

# 多路复用与解复用

多路复用和多路解复用是传输层使用网络层提供地服务的方式。两台主机上可能有多个进程互相进行通信，从网络层来看，这是同一个通信，因为其通信双方是相同的，多路复用与解复用就是为了实现这一点。多路复用指的是从多个套接字接收来自多个进程的报文，根据套接字对应的IP地址与端口号等信息对报文段进行封装；而多路解复用指的是根据报文段头部信息中的IP地址和端口号将接收到的报文段发给正确的套接字。

# 无连接传输：UDP

UDP（User Datagram Protocal）是一种无连接的传输层协议，发送端和接受端无需握手，是一种不可靠的传输协议，其数据报可能会丢失或者乱序。但是其优点也非常明确：不需要建立连接因为延迟低、简单，报文段头部小，没有拥塞控制和流量控制因为会尽可能快的发送数据报。

![](/assets/cn-3-1.jpg)

UDP校验和用于检测在被传输报文段中的错误。接收方接受到数据报后计算校验和，如果与报文中的校验和不一致，则有差错，数据报被丢弃；反之可能没有差错（可能存在残存错误）。

# 可靠数据传输的原理

可靠数据传输（RDT）是计算机网络中的重要问题之一，无论在应用层、传输层还是数据链路层，都要对该问题进行考虑。下面从多重假设到没有任何假设依次进行介绍。

## RDT1

RDT1中，假设下层信道是完全可靠的，即没有比特出错、没有分组丢失。在RDT1的前提下，只需要正确的封装与解封装数据即可提供可靠的数据传输。

## RDT2

RDT2假设，传输数据的信道可能会出现比特差错，即可能会将分组中的比特反转。

### RDT2.0

解决上述问题的方法是使用差错控制编码进行差错检测（校验和），接收方检错后向发送方回传确认信息ACK（确认）或NAK（否定确认）。如果是NAK，发送方需要重传当前分组。如果是ACK，发送下一个分组。

### RDT2.1

在RDT2的假设中，数据传输信道可能会出现比特差错，意味着回传的确认信息也可能出错，但RDT2.0并没有对该问题进行解决。RDT2.1中引入了序号机制，发送方在每个分组中添加序号，如果确认信息出错，则发送方重传当前分组，接收方重新发送确认信息的同时，根据序号判断是否是重复的分组。

需要注意的是，因为发送方是收到确认信息后才会发送下一次数据（重传或者发送新数据），因此序号只需要0/1交替。

### RDT2.2

RDT2.2的功能与2.1一致，但是通过给ACK添加序号（0/1交替序号）去除了NAK。接受方需要对最后正确接收的分组发ACK（ACK中需要包含分组序号信息），如果发送方接收到的ACK序号与当前分组序号不一致，意味着分组传输错误，需要重传。这样处理的意义除了减少确认信息，还为一次发送多个数据单位的处理做准备。

## RDT3

RDT3假设，传输数据的信道不仅会出现比特差错，还有可能丢失分组。解决上述问题的方法是超时重传，如果发送方超过一定的时间仍没有收到ACK，则会再次发送当前分组。

## 流水线协议

RDT3解决了数据传输信道中所有可能存在的问题，这种收到确认信息再发送下一次数据的方式在数据链路容量很大的情况下，性能较差。流水线协议就是为了提高链路利用率，其允许发送方在未得到对方确认的情况下一次发送多个分组，流水线协议要求增加序号的范围并且发送方和接收方要有缓冲区。

有两种基于流水线协议的通用协议：GBN和SR。

### 滑动窗口协议

滑动窗口协议是上述协议的一种通用描述。窗口指的是发送方（Sender Window）和接收方（Receiver Window）的一个缓存区域。如果SW=1、RW=1，指的是停止等待协议，即RDT3；如果SW>1、RW=1，指的是回退N步协议，即GBN；如果SW>1、RW>1，指的是选择重传协议，即SR。

发送缓冲区用于存放发送分组，其中已发送但未得到确认分组的连续区域，称为发送窗口。随着发送分组的进行，发送窗口不断扩大，直到最大值；发送的过程中也会收到分组确认消息，相应的分组要离开窗口，发送窗口又不断缩小。发送窗口以滑动的方式扩大和缩小，因此称为滑动窗口。

接收窗口和接收缓冲区的概念是一致的，接收窗口用于控制哪些分组可以接受（只有分组序号落入接收窗口内的分组才允许被接受，否则被抛弃），可以乱序接收，但只有当窗口内最小序号分组接收后窗口才滑动（保证不失序），接收分组后进行校验，返回当前组的确认信息。

### GBN协议和SR协议的区别

两种协议的直观区别就是接收窗口的大小不同，但是当接收窗口内的分组接收失败时，有较大的不同。SR协议中，发送窗口为每一个已发送的分组维护一个定时器，如果超时或出错，只需要重发对应分组。而GBN协议每次只能接受一个分组，如果中间的某一个分组超时了，那其后所有的分组都会超时，因此发送窗口只需要维护一个定时器，重传时重传所有未确认的分组。

GBN协议的优点是简单、所需要的资源小；但是一旦出错，其回退的代价很大（需要重传已确定分组后的所有分组）。而SR协议的优点是出错重传的代价小；但更复杂，所需要的资源更多。

# 面向连接的传输：TCP

## 段结构

TCP是一种可靠的、按顺序的字节流传输协议（可靠性算法基于流水线协议），通信双方要建立连接，TCP提供流量控制。

![](/assets/cn-3-2.jpg)

报文段中的序号指的是报文段首字节在字节流中的编号（字节流的大小往往大于报文段中数据部分的长度，因此要切割为N个报文段进行发送），确认号指的是期望从另一方收到的下一个字节的序号。

## 可靠数据传输

TCP在IP不可靠服务的基础上建立了RDT：

- 采用了流水线协议
- 累计确认（ACKn代表n之前所有数据报均已成功确认，目前期望接收第n字节的数据）
- 单个重传定时器（超时重传时只重传最先发送的未确认数据报）
- 对乱序没有规范

等待超时重传的周期往往太长，TCP设计了一种快速重传技术，接收方通过发送多个重复的ACK来告诉发送方数据丢失，发送方接收到冗余ACK后，要在定时器过时之前重发未确认的最小序号数据报，冗余ACK的数量代表了接收方收到的较大序号的数据报数量。

## 流量控制

流量控制指的是，接收方控制发送方，不让发送方发送的太快、太多，以至于让接收方的缓冲区溢出。

TCP具体的做法是，接收方在给发送方的ACK报文的TCP头部rwnd字段指明其缓冲区的空余大小，发送方再次发送的未确认数据报一定会小于缓冲区空余。

## 连接管理

TCP的连接管理方式可以简称为：三次握手、四次挥手。

### 建立连接

TCP是基于连接的通信协议，在正式交换数据之前，发送方和接收方握手建立通信关系。建立通信关系需要进行三次握手：

1. 发送方申请建立连接，并发送连接参数（例如字节初始序号、缓冲区大小等参数信息）；
2. 接收方确认建立连接，并返回连接参数；
3. 发送方发送接收确认，表明自己是活跃的。

为什么两次握手是不可行的呢？假设采取两次握手的方式：

1. 发送方向接收方申请建立连接；
2. 接收方确认建立连接后，开始维护该连接（称为连接A），但确认信息滞留在了网络中；
3. 由于发送方未收到确认信息，再次申请建立连接（称为连接B）；
4. 连接B还未建立之前，发送方收到了连接A的确认信息，开始通信并向接收方发送了数据报（称为数据报a）；
5. 数据报a的确认信息仍滞留在了网络中，发送方超时重传数据报（称为数据报b）；
6. 此时发送方收到了数据报a的确认信息，通信结束关闭连接A；
7. 关闭连接A后，接收方收到了连接B的建立申请并建立连接，一段时间后收到了数据报b。

可以发现在上述过程中，连接B并不是一个真正需要的连接，而是因为数据报超时重传发出了冗余的申请，因此两次握手会造成半连接问题，在建立起半连接后，还遇到了接收旧数据的问题。

### 关闭连接

当要关闭TCP时，发送方向接收方申请关闭，接收方返回确认信息，发送方关闭连接。上述关闭实际上是发送方不再主动与接收方进行通信，但接收方仍可以主动与发送方通信，因此接收方还需要重复上述步骤关闭连接。关闭过程中共有四次数据通信，称为四次挥手。

# 拥塞控制原理

拥塞指的是网络中需要传输的数据超过了网络的处理能力，拥塞会导致分组丢失（路由器缓冲区溢出）或是分组延迟大（在路由器队列中排队）。

解决拥塞常用的方法有端到端的控制和网络辅助的拥塞控制。端到端的拥塞控制没有来自网络的显示反馈，端系统根据延迟和丢失事件推断是否存在拥塞，TCP采用的一种方式。网络辅助的拥塞控制由路由器给端系统反馈信息，端系统根据反馈信息来进行判断。

# TCP拥塞控制

TCP采用端到端的拥塞控制，这样可以减轻路由器的负担，符合网络核心简单的TCP/IP架构原则。

## 拥塞感知

如果报文段发送超时，可能因为出错丢弃或网络拥塞，网络拥塞的概率比较大，因此一旦出现超时问题，认为发生了拥塞。如果某个报文段收到了3次ACK（触发快速重传），网络可能出现了轻微拥塞。

## 速率控制方法

发送方维护一个拥塞窗口的值（CongWin），限制已发送但未确认的数据量小于拥塞窗口，从而粗略地控制发送方往网络中注入的速率。CongWin是动态变化的，感知到拥塞后下降，数据ACK正常时上升。具体来说：

- 拥塞时：
  - 拥塞（超时）：CongWin降为1MSS，进入SS阶段（慢启动阶段）；
  - 轻微拥塞（3个重复ACK）：CongWin降为CongWin/2，进入CA阶段（拥塞避免阶段）；
- 正常时：
  - SS阶段：翻倍增加；
  - CA阶段：线性增加。

实际工作中，一般会对拥塞和流量同时控制，即SendWin=min{CongWin, RecvWin}。

## TCP拥塞控制的策略

TCP采取的拥塞控制策略采用了上述速率控制方法，并添加了连接慢启动和AIMD机制。

### 慢启动

在刚建立连接时，进入慢启动阶段，即连接建立时速率很慢，但成倍增加。

### AIMD

当发生了拥塞超时问题后，CongWin被设置成1MSS，进入SS阶段，之后窗口翻倍增加，直到增长为上次发生拥塞超时窗口值的一半，再线性增加。

### TCP的公平性

TCP的拥塞控制策略实现了公平性目标：如果K个TCP会话分享一个链路带宽为R的瓶颈，每一个会话的有效带宽为R/K。相反，UDP的特性是尽可能快的发出数据报，因此UDP不具有公平性。