---
title: 操作系统 —— VOL.2 操作系统结构
tags: "操作系统"
key: os-2
sidebar:
  nav: os
---

本系列是操作系统学习的记录笔记，参考了书籍《操作系统概念》。文章主要介绍操作系统的结构。<!--more-->

# 操作系统服务

- 操作系统提供环境以供执行程序，为程序及程序用户提供服务
- 用于提供用户功能的服务：
  - 用户界面：命令行界面(CLI)、图形用户界面(GUI)、批处理界面（指令打包成指令集）
  - 程序执行：系统必须能够将程序加载到内存中并运行，程序应能正常结束执行或给出错误
  - I/O操作：用户通常不应直接控制I/O设备，操作系统需要提供手段来执行I/O
  - 文件系统操作：程序需要读取、写入、创建、删除、搜索文件和目录、列出文件信息、权限管理等
  - 通信：进程可以在同一台计算机上或通过网络在计算机之间交换信息，使用共享内存技术和消息交换技术
  - 错误检测：
    - CPU或内存硬件、I/O设备、用户程序
    - 对于每类错误，需要给出恰当的措施保证计算的正确和一致
    - 调试可以极大地提高用户和程序员高效使用系统的能力
- 用于确保系统运行高效的服务：
  - 资源分配：当多个用户或多个作业并发运行时，必须为每个用户或多个作业分配资源
  - 记账：跟踪哪些用户使用多少和哪种类型的计算机资源
  - 保护与安全：存储在多用户或网络计算机系统中的信息需要控制信息使用，并发进程不应相互干扰
    - 保护确保可以控制系统资源的所有访问
    - 安全要求用户需要认证以获取系统资源的访问权限，保护外部I/O设备不受非法访问并记录所有非法的闯入企图

![](/assets/posts/os-2-1.jpg)

# 用户与操作系统的界面

- 命令行界面/命令解释程序：
  - 有的操作系统将其作为内核的一部分，有的操作系统将其作为系统程序
  - 对于具有多个可选命令解释程序的系统，其解释程序称为Shell
  - 主要功能：获取并执行用户的下一条命令
- 图形用户界面
  - 使用鼠标、键盘、监视器
  - 用图标来代表程序、文件、目录和系统功能
  - 图形界面上的各种按钮代表不同的程序与功能
- 许多操作系统同时拥有CLI和GUI两种界面
- 触摸屏设备需要新的界面：基于手势、提供虚拟键盘

# 系统调用

- 系统调用提供操作系统服务接口

- 通常使用高级语言编写，例如C/C++

- 用户程序通过高级语言提供的应用编程接口间接使用系统调用

- 系统调用的实现

  - 每个系统调用都有一个相关数字，每个系统调用接口会根据这些数字来建立一个索引列表

  - 系统调用接口可以调用操作系统内核中的所需系统调用，并返回系统调用状态与任何返回值

  - 调用者无需知道如何实现系统调用，只需遵守API；通过API，操作系统接口的大多数细节可隐藏起来

![](/assets/posts/os-2-2.jpg)

![](/assets/posts/os-2-3.jpg)

- 系统调用的参数传递：
  - 除了相应的系统调用外，还需要其他信息，所需信息的具体类型和数量根据特定操作系统和调用有所不同
  - 有三种常用的传递参数的方法：
    - 直接通过寄存器传递，适合于传递较少参数的情况
    - 将参数存在内存的块或表中，再将块或表的地址通过寄存器来传递
    - 通过程序压入堆栈，并通过操作系统弹出，这样的方法不限制传递参数的数量或长度

# 系统调用的类型

- 进程控制
  - 创建、终止进程
  - 结束、中止
  - 加载、执行
  - 获取进程属性、设置进程属性
  - 等待时间
  - 等待事件、信号事件
  - 分配和释放内存
  - 如果出错，转储内存
  - 用于确定错误的调试器，单步执行
  - 用于管理进程之间共享数据访问的锁
- 文件管理
  - 创建文件、删除文件
  - 打开、关闭
  - 读、写、重新定位
  - 获取文件属性、设置文件属性
- 设备管理
  - 请求设备、释放设备
  - 读、写、重新定位
  - 获取设备属性、设置设备属性
  - 逻辑附加或分离设备
- 信息维护
  - 获取时间或日期、设置时间或日期
  - 获取系统数据、设置系统数据
  - 获取进程、文件或设备属性
  - 设置进程、文件或设备属性
- 通信
  - 创建、删除通信连接
  - 发送、接受信息
  - 创建共享内存模型和访问内存区域
  - 传送状态信息
  - 附加或分离远程设备

# 系统程序

- 系统程序为程序开发和执行提供了方便的环境。它们可以分为：
  - 文件管理
  - 状态信息
  - 文件修改
  - 程序语言支持
  - 程序加载与执行
  - 通信
  - 后台服务
  - 应用程序
- 大多数用户理解的操作系统是：由应用程序和系统程序决定，而不是系统调用
- 文件管理，包括创建、删除、复制、重命名、打印、转储、列表，通常是对文件和目录进行操作
- 状态信息：
  - 向系统询问信息：日期、时间、可用内存量、磁盘空间、用户数量
  - 提供详细的性能、日志记录和调试信息
  - 通常，这些程序将输出格式化并打印到终端或其他输出设备
  - 一些系统实现注册表用于存储和检索配置信息
- 文件修改：
  - 文件编辑
  - 搜索文件内容或执行文本转换的特殊命令
- 程序语言支持包括编译器、汇编器、调试器和解释器
- 程序加载和执行包括绝对加载程序、重定位加载程序、链接编辑器和覆盖式加载程序、高级和机器语言的调试程序
- 通信：提供在进程、用户和计算机系统之间创建虚拟连接的机制，允许用户向彼此的屏幕发送消息，浏览网页，发送电子邮件，远程登录，将文件从一台机器传输到另一台机器
- 后台服务：
  - 在系统引导时创建系统程序的进程
    - 有的执行完任务就终止
    - 有的会一直运行到系统停机，称为服务、子系统或守护进程
  - 在用户上下文运行，而不是内核上下文
- 应用程序：
  - 与系统有关
  - 由用户通过命令行、鼠标、触控来运行
  - 不视为操作系统的一部分

# 操作系统的设计与实现

- 不同操作系统的内部结构可能差异很大
- 系统设计的首要问题是定义目标和规范
- 系统设计取决于所选硬件和系统类型
- 系统设计的需求，分为两大类：用户目标和系统目标
  - 用户目标：操作系统应该方便使用、易于学习和使用、可靠、安全和快速
  - 系统目标：操作系统应该易于设计、实施和维护，以及灵活、可靠、正确和高效的
- 操作系统的分析与设计是个很有创造性的任务，许多软件工程的主要原则对其非常有用
- 系统设计的一个重要原则是策略与机制的分离，机制决定如何做，策略决定做什么
- 早期，操作系统使用汇编语言编写，现在多用高级语言编写
- 操作系统可以使用多种语言编写，内核底层使用汇编，高层函数使用C，系统程序可以用C/C++、解释性脚本语言PERL或Python甚至是Shell脚本
- 使用高级语言代码编写更快、更紧凑、更易理解和调试，且更容易移植到其他硬件但是速度会更慢、使用更多的资源

# 操作系统的结构

- 通用目的的操作系统是一个非常大的程序
- 很多操作系统缺乏明确定义的结构，最初通常很小、功能有限，但逐渐超出了原来的范围
- 简单结构：MS-DOS
  - 目的是利用最小空间提供最多功能
  - 没有仔细地划分模块
  - 没有很好地区分功能的接口和层次

![](/assets/posts/os-2-4.jpg)

- 有限结构：UNIX
  - 受限于硬件功能，最初的UNIX由两个独立的模块组成：
    - 系统程序
    - 内核
      - 由系统调用接口之下和物理硬件之上的所有部分组成
      - 提供文件系统、CPU调度、内存管理和其他操作系统功能

![](/assets/posts/os-2-5.jpg)

- 分层结构
  - 操作系统分为若干层，每个层都构建在下层之上。底层（第0层）是硬件；最高层（第N层）是用户界面
  - 使用模块化，每个层只使用较低层的功能（操作）和服务
- 微内核结构
  - 使用微内核架构的操作系统，是通过从内核中删除所有非必要组件，并将其作为系统级和用户级程序实现的，删除的操作系统功能组件在用户模式下作为服务进程运行，并提供文件管理服务和驱动程序服务等服务
  - 优点：
    - 更容易扩展微内核
    - 更容易将操作系统移植到新架构
    - 更可靠（更少的代码在内核模式下运行）
    - 更安全
  - 缺点：用户空间到内核空间通信的性能开销较大
  - 特点：
    - 操作系统=内核+系统程序，内核=微内核+运行在用户态的服务进程
    - 当用户模式中的用户应用程序（或客户端程序）希望访问操作系统服务时，它通过与微内核的消息传递与在同一用户空间中提供此服务的操作系统服务进程间接交互，用户客户端程序和操作系统服务不会直接交互
  - 微内核的功能：
    - CPU调度
    - 中断处理
    - 基本的内存管理
    - 进程间通信

![](/assets/posts/os-2-6.jpg)

- 模块结构
  - 许多现代操作系统都实现了可加载内核模块
    - 使用面向对象的方法
    - 每个核心组件都是独立的
    - 组件间通过已知的接口进行通信
    - 组件可以根据需要在内核中加载
  - 与分层结构类似，但比分层结构更加灵活
- 混合结构
  - 大多数现代操作系统都没有单一的、严格定义的结构
    - 组合不同的结构形成混合结构以便解决性能、安全性和可用性等问题
    - Linux和Solaris混合了单片结构和动态加载的模块结构
    - Windows混合了单片结构和适用于不同子系统的微内核结构
  - Apple Mac OS X 采用了混合、分层、Aqua UI 和 Cocoa 编程环境

![](/assets/posts/os-2-7.jpg)

# 虚拟机

- 概念和原则
  - 抽象单个计算机的硬件（CPU、内存、磁盘驱动器、网络接口卡等）接入几种不同的执行环境
  - 每个执行环境如同运行一台独立的电脑
- 实现
  - 提供基础机器的副本
  - 在虚拟机中实现虚拟用户、虚拟内核两种模式
    - 均运行在物理用户模式中
    - 使用虚拟机中的系统调用
- 优点：
  - 全面保护系统资源
  - 各虚拟机之间是相互隔离的
  - 共享：
    - 在软件中实现物理共享磁盘
    - 在软件中实现的虚拟通信网络
- VMWare

![](/assets/posts/os-2-8.jpg)

- JVM

![](/assets/posts/os-2-9.jpg)

# 操作系统的生成

- 操作系统通常设计成能运行在一类计算机上，这些计算机可用于不同场所，并具有不同外设
- 对于某个特定的计算机场所，应配置和生成操作系统，称为系统生成
- 使用SYSGEN程序获取硬件系统的特定配置信息
  - 用于构建特定于系统的编译内核或对系统进行调优
  - 可以生成比通用内核更加高效的代码
- SYSGEN确定以下信息：
  - CPU：类型、指令集等
  - 内存：可用内存的大小
  - 设备：可用设备有哪些，设备号、设备终端号，设备类型、型号、特定等
  - 操作系统选项：参数值、缓冲区大小、调度算法、最大进程数等
- 方式：
  - 完全编译（完全定制）
  - 创建描述系统的表并从预先已编译的库中选择模块，将模块连接起来生成操作系统
  - 构造完全由表驱动的系统，系统的生成只是创建适当的表

# 系统引导

- 当系统初始化时，将从固定内存位置（0xFFFF0）开始执行
  - 存储在ROM或EPROM中的引导程序定位内核，将其加载到内存中，然后启动它
  - 有的操作系统是两个过程，固定内存位置存储着一个简单引导程序，该程序调入一个更复杂的引导程序，后者再加载内核
- 常见的引导加载程序GRUB允许从多个磁盘、版本、内核选项中选择内核